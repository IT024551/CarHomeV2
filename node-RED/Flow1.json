[{
		"id" : "509ce65a.5746c8",
		"type" : "tab",
		"label" : "Flow 1"
	}, {
		"id" : "be5bcc85.86a428",
		"type" : "ibmiot in",
		"z" : "509ce65a.5746c8",
		"authentication" : "apiKey",
		"apiKey" : "YOUR APIKEY",
		"inputType" : "evt",
		"deviceId" : "",
		"applicationId" : "",
		"deviceType" : "+",
		"eventType" : "+",
		"commandType" : "",
		"format" : "json",
		"name" : "Bluetooth device",
		"service" : "registered",
		"allDevices" : true,
		"allApplications" : true,
		"allDeviceTypes" : true,
		"allEvents" : true,
		"allCommands" : true,
		"allFormats" : true,
		"qos" : 0,
		"x" : 100,
		"y" : 380,
		"wires" : [["276a463a.679c4a", "9cd81bfa.fc969"]]
	}, {
		"id" : "276a463a.679c4a",
		"type" : "debug",
		"z" : "509ce65a.5746c8",
		"name" : "",
		"active" : true,
		"console" : "false",
		"complete" : "payload.d",
		"x" : 320,
		"y" : 440,
		"wires" : []
	}, {
		"id" : "aae9a72b.a50a7",
		"type" : "inject",
		"z" : "509ce65a.5746c8",
		"name" : "App Init",
		"topic" : "",
		"payload" : "",
		"payloadType" : "str",
		"repeat" : "",
		"crontab" : "",
		"once" : true,
		"x" : 100,
		"y" : 200,
		"wires" : [["79cca807.a7edf"]]
	}, {
		"id" : "79cca807.a7edf",
		"type" : "function",
		"z" : "509ce65a.5746c8",
		"name" : "Context Init",
		"func" : "\n   // bluetooth related\ncontext.global.bttime=0;\ncontext.global.rssimin=-5;\ncontext.global.rssi=-50;\ncontext.global.inBeacon=false;\n     \n// Timer related\ncontext.global.lastCmd=\"off\";\ncontext.global.lastSwitch=0;\ncontext.global.delay=1*1000; // 30 secs \n \nmsg.payload=\"App initialized\";\nreturn msg;",
		"outputs" : 1,
		"noerr" : 0,
		"x" : 269,
		"y" : 200,
		"wires" : [["678c8811.86d23"]]
	}, {
		"id" : "678c8811.86d23",
		"type" : "debug",
		"z" : "509ce65a.5746c8",
		"name" : "",
		"active" : true,
		"console" : "false",
		"complete" : "payload",
		"x" : 449,
		"y" : 200,
		"wires" : []
	}, {
		"id" : "fa7087e6.7505b8",
		"type" : "inject",
		"z" : "509ce65a.5746c8",
		"name" : "",
		"topic" : "",
		"payload" : "",
		"payloadType" : "date",
		"repeat" : "",
		"crontab" : "",
		"once" : false,
		"x" : 320,
		"y" : 320,
		"wires" : [["d649f5de.9c4d68"]]
	}, {
		"id" : "9cd81bfa.fc969",
		"type" : "function",
		"z" : "509ce65a.5746c8",
		"name" : "RSSI Mgmt",
		"func" : "context.global.rssi=msg.payload.d.rssi\ncontext.global.inBeacon=context.global.rssi>context.global.rssimin;\n\nreturn msg;",
		"outputs" : "2",
		"noerr" : 0,
		"x" : 310,
		"y" : 380,
		"wires" : [["d649f5de.9c4d68"], []],
		"outputLabels" : ["msg", "dbg"]
	}, {
		"id" : "d649f5de.9c4d68",
		"type" : "function",
		"z" : "509ce65a.5746c8",
		"name" : "Switch Action",
		"func" : "//\n// determine when to send a switch command\n// A command is sent when a grace period has \n// expired since last switch (to protect the\n// appliance) and if the state of the appliance \n// is to be changed\nnow = Date.now();\ndbg={ payload:\"\"};\nvar cmd=(context.global.inBeacon && context.global.inFence)? \"on\": \"off\";\nif (now - context.global.lastSwitch > context.global.delay && context.global.lastCmd != cmd) {\n // we need to switch now\n context.global.lastSwitch=now;\n context.global.lastCmd=cmd;\n msg.payload=cmd;\n msg.format=\"text\";\n dbg.payload=\"switch appliance '\"+cmd+\"'\";\n} else {\n msg=null\n dbg.payload=\"Appliance is currently \" + context.global.lastCmd + \". Not switching to \" + cmd + \" because delay is elapsed \" + (now - context.global.lastSwitch > context.global.delay) + \" and the state is different \" + (context.global.lastCmd != cmd);\n //dbg.payload=\"context.global.inBeacon=\"+context.global.inBeacon+ \" context.globalinFence=\"+context.global.inFence;\n}\nreturn [ msg, dbg ];",
		"outputs" : "2",
		"noerr" : 0,
		"x" : 490,
		"y" : 380,
		"wires" : [["431c06ff.10ff"], ["88807336.0b3a1"]],
		"outputLabels" : ["msg", "dbg"]
	}, {
		"id" : "431c06ff.10ff",
		"type" : "ibmiot out",
		"z" : "509ce65a.5746c8",
		"authentication" : "apiKey",
		"apiKey" : "YOUR API KEY",
		"outputType" : "cmd",
		"deviceId" : "b827eb2efe00",
		"deviceType" : "carproximity",
		"eventCommandType" : "switch",
		"format" : "text",
		"data" : "on",
		"qos" : 0,
		"name" : "Appliance cmd",
		"service" : "registered",
		"x" : 740,
		"y" : 320,
		"wires" : []
	}, {
		"id" : "88807336.0b3a1",
		"type" : "debug",
		"z" : "509ce65a.5746c8",
		"name" : "",
		"active" : true,
		"console" : "false",
		"complete" : "payload",
		"x" : 730,
		"y" : 380,
		"wires" : []
	}, {
		"id" : "73615388.0c186c",
		"type" : "http in",
		"z" : "509ce65a.5746c8",
		"name" : "",
		"url" : "/status",
		"method" : "get",
		"upload" : false,
		"swaggerDoc" : "",
		"x" : 90,
		"y" : 560,
		"wires" : [["4b0e8f84.5bdf2"]]
	}, {
		"id" : "4b0e8f84.5bdf2",
		"type" : "function",
		"z" : "509ce65a.5746c8",
		"name" : "Add global as payload",
		"func" : "msg.payload=context.global;\nmsg.payload.jt=Date.now();\nreturn msg;",
		"outputs" : 1,
		"noerr" : 0,
		"x" : 320,
		"y" : 560,
		"wires" : [["f28153d.841743"]]
	}, {
		"id" : "f28153d.841743",
		"type" : "http response",
		"z" : "509ce65a.5746c8",
		"name" : "Get Response",
		"statusCode" : "",
		"headers" : {},
		"x" : 580,
		"y" : 560,
		"wires" : []
	}, {
		"id" : "6560c7e1.8106c8",
		"type" : "http in",
		"z" : "509ce65a.5746c8",
		"name" : "",
		"url" : "/status",
		"method" : "post",
		"upload" : false,
		"swaggerDoc" : "",
		"x" : 90,
		"y" : 660,
		"wires" : [["14cf8905.0d5187"]]
	}, {
		"id" : "14cf8905.0d5187",
		"type" : "function",
		"z" : "509ce65a.5746c8",
		"name" : "update globals",
		"func" : "// modify parameters as they exists in msg.payload\nif (msg.payload.rssimin) context.global.rssimin=msg.payload.rssimin;\nmsg.payload=context;\nreturn msg;",
		"outputs" : 1,
		"noerr" : 0,
		"x" : 300,
		"y" : 660,
		"wires" : [["668c6a65.b117c4"]]
	}, {
		"id" : "668c6a65.b117c4",
		"type" : "http response",
		"z" : "509ce65a.5746c8",
		"name" : "Post Response",
		"statusCode" : "",
		"headers" : {},
		"x" : 580,
		"y" : 660,
		"wires" : []
	}, {
		"id" : "7d1c942a.0564cc",
		"type" : "ibmiot",
		"z" : "",
		"name" : "carhome-IOT",
		"keepalive" : "60",
		"serverName" : "i05oah.messaging.internetofthings.ibmcloud.com",
		"cleansession" : true,
		"appId" : "carhomeApp",
		"shared" : true
	}
]
